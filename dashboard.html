<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - KKG FABTEX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <nav class="navbar dashboard-nav">
        <div class="nav-container">
            <div class="logo-section">
                <img src="assets/logo.png" alt="KKG FABTEX" class="logo-small">
                <span class="nav-title">PO Management System</span>
            </div>
            <div class="nav-right">
                <a href="modules.html" class="btn-secondary" style="font-size: 0.85rem; padding: 0.5rem 1.2rem;">‚Üê Modules</a>
                <span class="user-name" id="userName"></span>
                <button onclick="logout()" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Purchase Orders Dashboard</h1>
            <div style="display: flex; gap: 1rem;">
                <button onclick="removePO()" class="btn-secondary" style="background: #dc2626; color: white; border: none;">üóëÔ∏è Delete PO</button>
                <a href="create-po.html" class="btn-primary">+ Create New PO</a>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalPOs">0</div>
                <div class="stat-label">Total POs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="nextPONumber">260</div>
                <div class="stat-label">Next PO Number</div>
            </div>
        </div>

        <div class="po-list-section">
            <h2>Recent Purchase Orders</h2>
            <div class="search-bar">
                <input type="text" id="searchPO" placeholder="Search by PO number, supplier name...">
            </div>
            <div id="poList" class="po-list">
                <!-- POs will be loaded here -->
            </div>
            <div id="emptyState" class="empty-state">
                <p>üìÑ No purchase orders yet</p>
                <p>Create your first PO to get started!</p>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="pdf-generator.js"></script>
    <script>
        // Check if user is logged in
        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'login.html';
        }
        
        // Display username
        document.getElementById('userName').textContent = localStorage.getItem('currentUser');
        
        // Load and display POs
        loadPOs();
        
        function loadPOs() {
            const pos = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const poList = document.getElementById('poList');
            const emptyState = document.getElementById('emptyState');
            const totalPOsEl = document.getElementById('totalPOs');
            const nextPOEl = document.getElementById('nextPONumber');
            
            totalPOsEl.textContent = pos.length;
            
            // Get next PO number
            const currentPONumber = parseInt(localStorage.getItem('currentPONumber') || '259');
            nextPOEl.textContent = currentPONumber + 1;
            
            if (pos.length === 0) {
                emptyState.style.display = 'block';
                poList.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            poList.style.display = 'block';
            
            // Sort by PO number (newest first)
            pos.sort((a, b) => b.poNumber - a.poNumber);
            
            poList.innerHTML = pos.map(po => `
                <div class="po-card">
                    <div class="po-header">
                        <div>
                            <h3>PO #${po.poNumber}</h3>
                            <p class="po-date">Created: ${po.date} by ${po.createdBy}</p>
                        </div>
                        <div class="po-actions">
                            <button onclick="viewPO(${po.poNumber})" class="btn-view">View</button>
                            <button onclick="downloadPO(${po.poNumber})" class="btn-download">Download PDF</button>
                        </div>
                    </div>
                    <div class="po-details">
                        <p><strong>Supplier:</strong> ${po.supplierName}</p>
                        <p><strong>Item:</strong> ${po.itemDescription.substring(0, 100)}${po.itemDescription.length > 100 ? '...' : ''}</p>
                        <p><strong>Quantity:</strong> ${po.quantity} | <strong>Rate:</strong> Rs ${po.rate}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function viewPO(poNumber) {
            const pos = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');
            const po = pos.find(p => p.poNumber === poNumber);
            
            if (po) {
                const details = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
PURCHASE ORDER #${po.poNumber}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Date: ${po.date}
Created by: ${po.createdBy}

SUPPLIER INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${po.supplierName}
${po.supplierAddress}

ITEM DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${po.itemDescription}

Quantity: ${po.quantity}
Rate: Rs ${po.rate}
Remarks: ${po.remarks || 'N/A'}

TERMS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Delivery: ${po.deliveryDate}
Payment Terms: ${po.paymentTerms}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                `;
                alert(details);
            }
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
        
        function removePO() {
            const pos = JSON.parse(localStorage.getItem('purchaseOrders') || '[]');

            if (pos.length === 0) {
                alert('No purchase orders to remove!');
                return;
            }

            const poNumberStr = prompt('Enter the PO number you want to delete:');

            if (!poNumberStr) {
                return; // User cancelled
            }

            const poNumber = parseInt(poNumberStr);

            if (isNaN(poNumber)) {
                alert('‚ùå Invalid PO number entered!');
                return;
            }

            const poToDelete = pos.find(p => p.poNumber === poNumber);

            if (!poToDelete) {
                alert(`‚ùå PO #${poNumber} not found.`);
                return;
            }

            const confirmMessage = `‚ö†Ô∏è CONFIRM DELETION:\n\n` +
                `PO #${poToDelete.poNumber}\n` +
                `Supplier: ${poToDelete.supplierName}\n` +
                `Date: ${poToDelete.date}\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Type "DELETE" to confirm:`;

            const confirmation = prompt(confirmMessage);

            if (confirmation === 'DELETE') {
                const updatedPOs = pos.filter(p => p.poNumber !== poNumber);
                localStorage.setItem('purchaseOrders', JSON.stringify(updatedPOs));

                // Update PO counter based on which PO was deleted
                const currentCounter = parseInt(localStorage.getItem('currentPONumber') || '259');
                if (updatedPOs.length === 0) {
                    // All POs deleted - reset counter so next PO reuses deleted number
                    localStorage.setItem('currentPONumber', (poNumber - 1).toString());
                } else {
                    // Find the highest remaining PO number
                    const highestRemaining = Math.max(...updatedPOs.map(p => p.poNumber));
                    if (poNumber > highestRemaining) {
                        // Deleted the last PO - next PO reuses that number
                        localStorage.setItem('currentPONumber', (poNumber - 1).toString());
                    } else {
                        // Deleted from middle - next PO is incremental of last existing
                        localStorage.setItem('currentPONumber', highestRemaining.toString());
                    }
                }

                alert(`‚úÖ PO #${poNumber} has been deleted successfully!`);
                location.reload();
            } else {
                alert('‚ùå Deletion cancelled. Confirmation text did not match.');
            }
        }
        
        // Search functionality
        document.getElementById('searchPO').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const poCards = document.querySelectorAll('.po-card');
            
            poCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>